<% content_for :page_title,  "Les Emprunts" %>

<div class="d-flex justify-content-between mb-5 mt-5">
  <h1></h1>
  <%= button_to "Ajouter Emprunt", new_emprunt_path, class:"btn btn-outline-primary bi bi-plus", :method => "get" %>
</div>

<h2>Document emprunts</h2>
<div id="emprunts">
  <table class="table mt-5">
        <thead>
          <tr>
            <th scope="col">ID</th>
            <th scope="col">Document ID</th>
            <th scope="col">Titre</th>
            <th scope="col">Adherent</th>
            <th scope="col">Ajouté</th>
            <th scope="col">Actions</th>
          </tr>
        </thead>
        <tbody>
      <% @emprunt_documents.each do |emprunt_document| %>
        <tr>
          <th scope="row">
            <%= emprunt_document["emprunt_id"] %>
          </th>
          <th scope="row">
            <%= emprunt_document["document_id"] %>
          </th>
          <td>
            <%= emprunt_document["document_name"] %>
          </td>

          <td>
            <%="#{emprunt_document["ad_nom"]} #{emprunt_document["ad_prenom"]} " %>
          </td>
          <td>
            <%= Date.parse(emprunt_document["created_at"]).strftime("%Y-%m-%d %H:%M") %>
          </td>

          <td>
            <%= link_to "",  emprunt_path(id:emprunt_document["emprunt_id"]), class:"btn btn-outline-primary bi bi-eye", :method => "get" %>
          </td>
        
          </tr>
        <% end %>
        </tbody>
  </table>

  <h2 class="mb-5" >Ordinateur emprunts</h2>
      <table class="table">
            <thead>
              <tr>
                <th scope="col">ID</th>
                <th scope="col">Ordinateur ID</th>
                <th scope="col">Nom Ordinateur</th>
                <th scope="col">Adherent</th>
                <th scope="col">Ajouté</th>
                <th scope="col">Actions</th>
              </tr>
            </thead>
            <tbody>
          <% @emprunt_ordinateur.each do |emprunt_ordinateur| %>
            <tr>
              <th scope="row">
                <%= emprunt_ordinateur["emprunt_id"] %>
              </th>
              <th scope="row">
                <%= emprunt_ordinateur["materiel_id"] %>
              </th>
              <td>
                <%= emprunt_ordinateur["materiel_name"] %>
              </td>

              <td>
                <%="#{emprunt_ordinateur["ad_nom"]} #{emprunt_ordinateur["ad_prenom"]} " %>
              </td>
              <td>
                <%= Date.parse(emprunt_ordinateur["created_at"]).strftime("%Y-%m-%d %H:%M") %>
              </td>

              <td>
                <%= link_to "",  emprunt_path(id:emprunt_ordinateur["emprunt_id"]), class:"btn btn-outline-primary bi bi-eye", :method => "get" %>
              </td>
            
              </tr>
            <% end %>
            </tbody>
  </table>
</div>
<%= button_to "Export To CSV", "#", id: "exportBtn", class: "btn btn-primary", method: :get %>

<script>
  document.getElementById("exportBtn").addEventListener("click", function() {
    // Create an array to store the CSV data
    let csvData = [];
    // Add the CSV header
    csvData.push(["ID","DOCUMENT_NAME", "ADHERENT_NOM", "ADHERENT_PRENOM", "Created"]);

    // Iterate over each emprunt to get its information
    <% if @emprunt_documents.present? %> 
      <% @emprunt_documents.each do |emprunt_document| %>
        csvData.push(["<%= emprunt_document["emprunt_id"] %>", "<%= emprunt_document["document_name"] %>", "<%= emprunt_document["ad_nom"] %>", "<%= emprunt_document["ad_prenom"] %>", "<%= emprunt_document["created_at"] %>"]);
      <% end %>
    <% end %>
    <% if @emprunt_ordinateur.present? %> 
      <% @emprunt_ordinateur.each do |emprunt_ordinateur| %>
        csvData.push(["<%= emprunt_ordinateur["emprunt_id"] %>", "<%= emprunt_ordinateur["materiel_name"] %>", "<%= emprunt_ordinateur["ad_nom"] %>", "<%= emprunt_ordinateur["ad_prenom"] %>", "<%= emprunt_ordinateur["created_at"] %>"]);
      <% end %>
    <% end %>

    // Convert the array into CSV string
    let csvContent = "data:text/csv;charset=utf-8," + csvData.map(row => row.join(",")).join("\n");

    // Create an anchor element to download the CSV file
    let encodedUri = encodeURI(csvContent);
    let link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "emprunts.csv");
    document.body.appendChild(link);

    // Click the link to download the CSV file
    link.click();
  });
</script>
